{% extends "dashboard_base.html" %}

{% comment %}
Copyright (c) 2024 Qu Zhi
All Rights Reserved.

This software is proprietary and confidential.
Unauthorized copying, distribution, or modification of this software is strictly prohibited.
{% endcomment %}

{% load i18n %}


{% block main_content %}

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div></div> <!-- empty left side -->
    <a href="{% url 'interaction_space' %}" style="font-weight: bold;">
        {% trans "‚Üí Interaction Space" %}
    </a>
  </div>

  <h3>{% trans "My Simulations" %} ({{ total_simulations }})</h3>
  
  {% if page_obj %}
  <form method="post" action="{% url 'delete_selected_simulations' %}" id="delete-form">
    {% csrf_token %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>{% trans "Time" %}</th>
                    <th>{% trans "Preview" %}</th>
                    <th>{% trans "Type" %}</th>
                    <th><input type="checkbox" id="select-all"></th>
                </tr>
            </thead>
            <tbody>
                {% for sim in page_obj %}
                <tr>
                    <td>
                        {% if LANGUAGE_CODE == "zh-hans" %}
                            {{ sim.created_at|date:"YÂπ¥nÊúàjÊó• H:i" }}
                        {% else %}
                            {{ sim.created_at|date:"M. d, Y H:i" }}
                        {% endif %}
                    </td>
                    <td>
                        {% if sim.type == "Generated" %}
                            <a href="{% url 'generated_simulation_detail' pk=sim.id %}">
                            {{ sim.scenario|truncatechars:30 }}
                            </a>
                        {% else %}
                            <a href="{% url 'live_simulation_detail' pk=sim.id %}">
                            {{ sim.scenario|truncatechars:30 }}
                            </a>
                        {% endif %}
                    </td>
                    <td>
                        {% if sim.type == "Generated" %}
                            {% trans "Generated" %}
                        {% else %}
                            {% trans "Live" %}
                        {% endif %}
                    </td>
                    <td>
                        <input type="checkbox" name="selected_sims"
                            value="{{ sim.id }}" data-type="{{ sim.type }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div> 

    <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
        <button type="submit" class="btn btn-danger" id="delete-btn" disabled>
        üóëÔ∏è {% trans "Delete Selected" %}
        </button>
    </div>
  </form>  
  {% else %}  
   <p>{% trans "You have not yet run any simulations." %}</p>
  {% endif %}

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
        <h4>{% trans "Confirm Deletion" %}</h4>
        <p>{% trans "Are you sure you want to delete the selected simulations? This action cannot be undone." %}</p>
        <div class="modal-actions">
            <button id="confirm-yes" class="btn btn-danger">{% trans "Yes, Delete" %}</button>
            <button id="confirm-no" class="btn btn-secondary">{% trans "Cancel" %}</button>
        </div>
    </div>
  </div>


  {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation">
      <ul class="pagination">

        <!-- Previous Link -->
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous"> 
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&laquo;</span>
          </li>
        {% endif %}

        <!-- Page Numbers -->
        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% elif forloop.first or forloop.last %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          {% endif %}
        {% endfor %}

        <!-- Next Link -->
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  <script>
    // === Checkbox and modal logic ===

    // Get elements
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="selected_sims"]');
    const deleteBtn = document.getElementById('delete-btn');
    const form = document.getElementById('delete-form');
    const modal = document.getElementById('confirm-modal');
    const confirmYes = document.getElementById('confirm-yes');
    const confirmNo = document.getElementById('confirm-no');

    // --- Enable or disable delete button depending on selection ---
    function updateDeleteButton() {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        deleteBtn.disabled = !anyChecked;
    }

    // --- "Select All" checkbox toggle ---
    if (selectAll) {
        selectAll.addEventListener('change', (e) => {
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateDeleteButton();
        });
    }

    // --- Each checkbox updates delete button ---
    checkboxes.forEach(cb => cb.addEventListener('change', updateDeleteButton));

    // --- Intercept form submission ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Collect selected items
        const selectedData = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => `${cb.dataset.type}:${cb.value}`); // e.g., "Generated:12"

        if (selectedData.length === 0) {
            alert("{% trans 'Please select at least one simulation to delete.' %}");
            return;
        }

        // Create or update hidden input field with selected IDs + types
        let hiddenInput = document.getElementById("selected-items");
        if (!hiddenInput) {
            hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "selected_data";
            hiddenInput.id = "selected-items";
            form.appendChild(hiddenInput);
        }
        hiddenInput.value = selectedData.join(",");

        // Show modal for confirmation
        modal.style.display = 'flex';
    });

    // --- Confirm delete ---
    confirmYes.addEventListener('click', () => {
        modal.style.display = 'none';
        form.submit();  // proceed with submission to backend
    });

    // --- Cancel delete ---
    confirmNo.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // --- Close modal when clicking outside ---
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
 </script>

{% endblock %}
